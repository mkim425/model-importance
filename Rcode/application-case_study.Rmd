---
title: "Application-case_study"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
# knitr::opts_chunk$set(fig.width=10, fig.height=8) 
library(covidHubUtils)
library(dplyr)
library(lubridate)
library(stringr)
library(ggplot2)
# install.packages("ggridges")
library(ggridges)
library(ggrepel)
library(ggpubr)
library(gridExtra)
library(grid)
library(doParallel)
library(tidyverse)
theme_set(theme_bw())
library(pander)
library(DT)
library(ggalt)  #for geom_dumbbell()
library(pander)
library(kableExtra)
library(ggprism)
library(patchwork)
library(stringr)
# get_all_models()
# datatable(fdat)
library(here)
setwd(here())
```

# Load forecast data of death in MA in 2021

This dataset contains 9 models, their importance score, and WIS on each target end date for 4-week ahead incident death.

```{r load_data_forecast_ma2021, echo = FALSE}
forecast_ma2021_full <- readRDS("../Data/forecast_death_ma2021.rds")

forecast_ma2021 <- forecast_ma2021_full %>% 
  rename(f.median = 'X0.5') %>% 
  select(model, importance, wis, target_end_date, location, target, 
         dispersion, overpred, underpred, f.median) 
```

# Plot of prediction intervals of 9 models and ensembles constructed by leave-one-model-out algorithm

```{r}
truth.ma.2021 <- read_csv("../Data/truth_MA_2021.csv") %>% 
  select(target_end_date, value) %>% 
  rename(truth = value)

y.val= truth.ma.2021$truth[truth.ma.2021$target_end_date == "2021-12-25"] 

# lock in factor level order
forecast_ma2021_full.v2 <- forecast_ma2021_full %>% 
  mutate(model_order = factor(model, levels = unique(model))) %>% 
  relocate(model_order)

d <- forecast_ma2021_full.v2 %>% 
        filter(target_end_date == "2021-12-25") %>% 
        select(model_order, 8:30)
level <- d$model_order[c(11:19, 10)]
d1 <- d[c(10, 1:9), ]
d2 <- d[c(10:19), ]


# Prediction intervals of single models
p1 <- d[c(1:9), ] %>% 
        ggplot(aes(y = model_order)) + 
        geom_dumbbell(aes(x = X0.025, xend = X0.975)) +
        geom_point(aes(x = X0.5 ) ) + 
        scale_y_discrete(labels = function(x) str_wrap(x, width = 9)) +
        geom_vline(xintercept = y.val, linetype="dashed", 
                      size=0.5, colour="darkred") +
        labs(x="Value", y="Model", title="95% Prediction Intervals of Individual Forecasts") + 
        theme(axis.text.x = element_text(size=8, angle = 30, hjust = 1),
              legend.position = "none") +
        theme(axis.title.x = element_blank(),
              axis.text.x = element_text(size = 10),
              axis.title.y = element_text(size = 16)) +
        theme(text = element_text(size = 12)) + coord_flip() 


# Prediction intervals of ensemble models

d2.copy <- d2 %>% mutate(model_rename = model_order) %>% relocate(model_rename)
d2.copy$model_rename <- str_remove(d2.copy$model_rename, pattern = "Ens.wo.")
model_level <- d2.copy$model_rename[c(2:10, 1)]
breaks2 <- c(seq(0, 700, by=100))
labels2 <- as.character(breaks2)

p2 <- d2.copy %>%
        mutate(name = factor(model_rename, levels=model_level)) %>% 
        relocate(name) %>% 
        ggplot(aes(y = name)) + 
        geom_dumbbell(aes(x = X0.025, xend = X0.975)) +
        geom_point(aes(x = X0.5 ) ) +
        scale_x_continuous(limits = c(-10, 500), breaks = breaks2, labels = labels2) +
        scale_y_discrete(labels = function(x) str_wrap(x, width = 9)) +
        geom_vline(xintercept = y.val, linetype="dashed", 
                      size=0.5, colour="darkred") +
        labs(x="Value", y="Model", title="95% Prediction Intervals of Ensembles Built Excluding a Single Model") + 
        theme(axis.text.x = element_text(size=8, angle = 30, hjust = 1),
              legend.position = "none") +
        theme(axis.title.x = element_text(size = 16),
              axis.text.x = element_text(size = 10)) +
        theme(text = element_text(size = 12))  + coord_flip()   
```

```{r}
pdf(file="../Plot/95PI1.pdf",
    width = 6,
    height = 3)
p1
dev.off()
```
```{r}
pdf(file="../Plot/95PI2.pdf",
    width = 8,
    height = 4)
p2
dev.off()
```

# Plot of Importance vs. WIS on 2021-12-25 
 
This plot shows that there is an inaccurate but important model because, while this model had a large positive bias, it was the only model that was biased in that direction on this particular week.
That bias, in this situation, therefore made this model an “important” counter-weight to all of the other models.

```{r}
require("ggrepel")

p.imp_wis.1225 <- forecast_ma2021_full.v2 %>%
        filter(target_end_date == "2021-12-25") %>%
        filter(!grepl('Ens', model)) %>% 
        ggplot(aes(x=wis, y = importance, color=model_order)) + 
        geom_point(size = 2.5) + 
        scale_color_manual(values=col_vector) +
        xlim(0,130) + 
        labs(y = "Importance",
             x = "WIS") + 
        theme(axis.text=element_text(size=12),
              axis.title=element_text(face = "bold"),
              legend.position="none")


pdf(file="../Plot/plot-wis_imp_20211225.pdf",
    width = 10,
    height = 5)
p.imp_wis.1225 
dev.off()
```

# Scatterplots of importance vs. WIS by model

```{r plot_importance-vs-wis-by-model, fig.pos='h', fig.cap="left-aligned"}
p <- forecast_ma2021 %>% 
  filter(!grepl('Ens', model)) %>% 
  mutate(target_end_date=str_remove(target_end_date, "2021-")) %>% 
  ggplot(aes(x=wis)) + 
  geom_point(aes(y = importance)) +
  facet_wrap(~ model) + 
  labs(#title = "Model importance vs. WIS by Model",
          x = "WIS",
          y = "Importance") + 
  theme(legend.position = "none")

pdf(file="../Plot/scatterplot-wis_imp2021.pdf",
    width = 10,
    height = 5)
p
dev.off()
```







